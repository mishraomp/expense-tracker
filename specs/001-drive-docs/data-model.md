# Data Model: Google Drive Document Storage Integration

## Entities

### Attachment
Represents a single document stored in Google Drive and linked to either an Expense or Income.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | UUID | PK | Generated by DB |
| driveFileId | string | NOT NULL | Google Drive file identifier |
| linkedExpenseId | UUID | NULLABLE FK -> Expense(id) | One of expense or income must be set |
| linkedIncomeId | UUID | NULLABLE FK -> Income(id) | Mutually exclusive with linkedExpenseId (enforced by CHECK) |
| mimeType | string | NOT NULL | Must be in whitelist (pdf,png,jpeg,jpg,xlsx,docx) |
| sizeBytes | int | NOT NULL | <= 5 * 1024 * 1024 |
| originalFilename | string | NOT NULL | Sanitized, no path separators |
| checksum | string | NOT NULL | SHA-256 of file content (client-side or after upload) |
| webViewLink | string | NOT NULL | Link returned by Drive (or constructed) |
| uploadedByUserId | UUID | NOT NULL FK -> User(id) | Owner for privacy scope |
| createdAt | timestamptz | NOT NULL DEFAULT now() |  |
| replacedByAttachmentId | UUID | NULLABLE FK -> Attachment(id) | Points to successor on replace |
| status | enum (active, removed, orphan) | NOT NULL DEFAULT 'active' |  |
| retentionExpiresAt | timestamptz | NULLABLE | Set when status transitions to removed |
| driveRecordType | enum (expense,income) | NOT NULL | Duplication for faster filtering |
| driveRecordDate | date | NOT NULL | Copy of record date for search |
| driveAmountMinorUnits | bigint | NOT NULL | Monetary amount scaled (e.g. cents) |
| driveCategoryId | UUID | NULLABLE FK -> Category(id) | For category-based filtering |

Indexes:
- `idx_attachment_expense` on (linkedExpenseId)
- `idx_attachment_income` on (linkedIncomeId)
- `idx_attachment_status_retention` on (status, retentionExpiresAt)
- `idx_attachment_drive_props` on (driveRecordType, driveRecordDate, driveCategoryId)

Constraints:
- CHECK exactly one of linkedExpenseId, linkedIncomeId non-null.
- Unique (driveFileId) to prevent duplicate metadata.
- sizeBytes <= 5MB enforced in application + DB CHECK.

### BulkImportJob
Tracks a batch upload process for linking multiple local files.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| id | UUID | PK |  |
| initiatedByUserId | UUID | NOT NULL FK -> User(id) |  |
| totalFiles | int | NOT NULL | Snapshot at start |
| uploadedCount | int | NOT NULL DEFAULT 0 | Incremental progress |
| skippedCount | int | NOT NULL DEFAULT 0 | Invalid/blocked |
| duplicateCount | int | NOT NULL DEFAULT 0 | Checksums previously seen |
| errorCount | int | NOT NULL DEFAULT 0 | Failures |
| status | enum(pending,running,completed,canceled,failed) | NOT NULL |  |
| startedAt | timestamptz | NULLABLE | Set when status -> running |
| finishedAt | timestamptz | NULLABLE | Set when terminal state |

Indexes:
- `idx_bulk_job_user_status` on (initiatedByUserId, status)

### UserDriveAuth (optional initial table)
Stores encrypted refresh token reference and last validation.

| Field | Type | Constraints | Notes |
|-------|------|-------------|-------|
| userId | UUID | PK FK -> User(id) |  |
| encryptedRefreshToken | string | NOT NULL | Encryption at rest (future KMS) |
| scopes | text[] | NOT NULL | Granted scopes snapshot |
| lastValidatedAt | timestamptz | NOT NULL DEFAULT now() | Timestamp of token check |

### Orphan Detection (transient)
Result generated by job — not persisted initially. May evolve into table if volume warrants.

## State Transitions

Attachment status transitions:
- `active` -> `removed` (user removal) sets `retentionExpiresAt = now() + interval '7 days'`.
- `active` -> `orphan` (scan identifies missing DB linkage) triggers remediation path.
- `removed` -> purge (job) deletes row + Drive file.

BulkImportJob transitions:
- `pending` -> `running` -> (`completed` | `failed` | `canceled`).

## Migrations
Planned migration file: `V2.5.0__attachments.sql`
- Create `Attachment` table + indexes + CHECK constraints.
- Create `BulkImportJob` table.
- Optional `UserDriveAuth` table (may defer; can store encrypted token in existing user preferences if simpler — ADR will decide).

## Validation Rules
- File size ≤5MB (pre-upload & DB CHECK `sizeBytes <= 5242880`).
- Allowed mimeType set; reject others.
- Max 5 attachments per record enforced by counting existing attachments before insert.
- Replacement: new attachment inserted; old attachment gets `replacedByAttachmentId` and status stays `active` (or transitions to `removed` if immediate archival desired — ADR to finalize). Current plan: treat replaced as `removed` with retention.

## Open Design Questions (to resolve in ADRs)
- Whether to persist `UserDriveAuth` vs rely on Keycloak tokens plus a refresh process.
- Replacement semantics: keep both vs archive vs soft delete.

## No Outstanding Clarifications
All fields reflect resolved spec requirements.
