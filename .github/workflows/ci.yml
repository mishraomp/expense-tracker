name: ci

on:
  pull_request:

permissions:
  contents: read
  actions: write

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changed.outputs.backend_changed }}
      frontend_changed: ${{ steps.changed.outputs.frontend_changed }}
      auth_changed: ${{ steps.changed.outputs.auth_changed }}
      e2e_required: ${{ steps.changed.outputs.e2e_required }}
      compose_required: ${{ steps.changed.outputs.compose_required }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        id: changed
        shell: bash
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          mapfile -t CHANGED_FILES < <(git diff --name-only "$BASE_SHA" "$HEAD_SHA" || true)

          backend_changed=false
          frontend_changed=false
          auth_changed=false

          for f in "${CHANGED_FILES[@]:-}"; do
            if [[ "$f" == backend/* ]]; then
              backend_changed=true
            fi
            if [[ "$f" == frontend/* ]]; then
              frontend_changed=true
            fi
            if [[ "$f" == backend/src/common/guards/* || "$f" == backend/src/app.module.ts ]]; then
              auth_changed=true
            fi
          done

          if [[ "$frontend_changed" == true || "$auth_changed" == true ]]; then
            e2e_required=true
          else
            e2e_required=false
          fi

          if [[ "$backend_changed" == true || "$frontend_changed" == true ]]; then
            compose_required=true
          else
            compose_required=false
          fi

          {
            echo "backend_changed=$backend_changed"
            echo "frontend_changed=$frontend_changed"
            echo "auth_changed=$auth_changed"
            echo "e2e_required=$e2e_required"
            echo "compose_required=$compose_required"
          } >> "$GITHUB_OUTPUT"

  backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Install backend dependencies
        uses: ./.github/actions/npm-ci
        with:
          working-directory: backend

      - name: Lint (backend)
        shell: bash
        working-directory: backend
        run: npm run lint

      - name: Ensure lint made no changes (backend)
        shell: bash
        run: git diff --exit-code

      - name: Unit tests + coverage (backend)
        shell: bash
        working-directory: backend
        run: npm run test:cov

      - name: Coverage gate (backend)
        shell: bash
        run: |
          node -e '
            const fs = require("fs");

            const reportPath = "backend/coverage/coverage-final.json";
            const minLines = 85;
            const minBranches = 75;

            if (!fs.existsSync(reportPath)) {
              console.error(`Coverage report not found: ${reportPath}`);
              process.exit(1);
            }

            const coverage = JSON.parse(fs.readFileSync(reportPath, "utf8"));

            let totalLines = 0;
            let coveredLines = 0;
            let totalBranches = 0;
            let coveredBranches = 0;

            for (const file of Object.values(coverage)) {
              if (file && typeof file === "object") {
                const lines = file.l || {};
                for (const hit of Object.values(lines)) {
                  totalLines += 1;
                  if (typeof hit === "number" && hit > 0) coveredLines += 1;
                }

                const branches = file.b || {};
                for (const arr of Object.values(branches)) {
                  if (Array.isArray(arr)) {
                    for (const hit of arr) {
                      totalBranches += 1;
                      if (typeof hit === "number" && hit > 0) coveredBranches += 1;
                    }
                  }
                }
              }
            }

            const pct = (covered, total) => (total === 0 ? 100 : (covered / total) * 100);
            const linesPct = pct(coveredLines, totalLines);
            const branchesPct = pct(coveredBranches, totalBranches);

            console.log(`Backend coverage: lines ${linesPct.toFixed(2)}% (${coveredLines}/${totalLines}), branches ${branchesPct.toFixed(2)}% (${coveredBranches}/${totalBranches})`);

            const errors = [];
            if (linesPct + 1e-9 < minLines) errors.push(`lines < ${minLines}%`);
            if (branchesPct + 1e-9 < minBranches) errors.push(`branches < ${minBranches}%`);

            if (errors.length) {
              console.error(`Coverage gate failed: ${errors.join(", ")}`);
              process.exit(1);
            }
          '

  frontend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Install frontend dependencies
        uses: ./.github/actions/npm-ci
        with:
          working-directory: frontend

      - name: Lint (frontend)
        shell: bash
        working-directory: frontend
        run: npm run lint

      - name: Ensure lint made no changes (frontend)
        shell: bash
        run: git diff --exit-code

      - name: Unit tests + coverage (frontend)
        shell: bash
        working-directory: frontend
        run: npm run test:cov

      - name: Coverage gate (frontend)
        shell: bash
        run: |
          node -e '
            const fs = require("fs");

            const reportPath = "frontend/coverage/coverage-final.json";
            const minLines = 80;

            if (!fs.existsSync(reportPath)) {
              console.error(`Coverage report not found: ${reportPath}`);
              process.exit(1);
            }

            const coverage = JSON.parse(fs.readFileSync(reportPath, "utf8"));

            let totalLines = 0;
            let coveredLines = 0;

            for (const file of Object.values(coverage)) {
              if (file && typeof file === "object") {
                const lines = file.l || {};
                for (const hit of Object.values(lines)) {
                  totalLines += 1;
                  if (typeof hit === "number" && hit > 0) coveredLines += 1;
                }
              }
            }

            const linesPct = totalLines === 0 ? 100 : (coveredLines / totalLines) * 100;
            console.log(`Frontend coverage: lines ${linesPct.toFixed(2)}% (${coveredLines}/${totalLines})`);

            if (linesPct + 1e-9 < minLines) {
              console.error(`Coverage gate failed: lines < ${minLines}%`);
              process.exit(1);
            }
          '

  compose-smoke:
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.compose_required == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create empty .env for docker compose
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f .env ]; then
            : > .env
          fi

      - name: Start docker-compose stack
        shell: bash
        run: |
          set -euo pipefail
          docker compose up -d --build postgres flyway keycloak keycloak-config api frontend

      - name: Wait for API health
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..60}; do
            if curl -fsS http://localhost:3000/health > /dev/null; then
              echo "API is healthy"
              break
            fi
            sleep 5
          done

          if ! curl -fsS http://localhost:3000/health > /dev/null; then
            echo "API healthcheck failed"
            docker compose ps
            docker compose logs --no-color --tail=200
            exit 1
          fi

      - name: Wait for frontend
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..60}; do
            if curl -fsS http://localhost:5173/ > /dev/null; then
              echo "Frontend is up"
              exit 0
            fi
            sleep 5
          done
          echo "Frontend did not become ready"
          docker compose ps
          docker compose logs --no-color --tail=200
          exit 1

      - name: Teardown
        if: ${{ always() }}
        shell: bash
        run: docker compose down -v

  e2e:
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.e2e_required == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: ./.github/actions/setup-node

      - name: Create empty .env for docker compose
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f .env ]; then
            : > .env
          fi

      - name: Start docker-compose stack
        shell: bash
        run: |
          set -euo pipefail
          docker compose up -d --build postgres flyway keycloak keycloak-config api frontend

      - name: Wait for frontend
        shell: bash
        run: |
          set -euo pipefail
          for i in {1..60}; do
            if curl -fsS http://localhost:5173/ > /dev/null; then
              echo "Frontend is up"
              exit 0
            fi
            sleep 5
          done
          echo "Frontend did not become ready"
          docker compose ps
          docker compose logs --no-color --tail=200
          exit 1

      - name: Install frontend dependencies
        uses: ./.github/actions/npm-ci
        with:
          working-directory: frontend

      - name: Install Playwright browsers
        shell: bash
        working-directory: frontend
        run: npm run e2e:install

      - name: Run Playwright E2E
        shell: bash
        working-directory: frontend
        env:
          E2E_BASE_URL: http://localhost:5173
        run: npm run e2e:ci

      - name: Upload Playwright report
        if: ${{ always() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report
          if-no-files-found: ignore

      - name: Teardown
        if: ${{ always() }}
        shell: bash
        run: docker compose down -v
